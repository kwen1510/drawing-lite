<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher - Classroom Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      color-scheme: light;
    }
    .color-btn {
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .color-btn:hover {
      transform: scale(1.05);
    }
    .color-btn.active {
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.95), 0 0 0 6px rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.65);
    }
    .tool-btn.active {
      background: rgb(139 92 246);
      color: white;
      border-color: rgb(139 92 246);
      box-shadow: 0 10px 25px rgba(139, 92, 246, 0.25);
    }
    .stylus-indicator.off {
      background: rgb(226 232 240);
      color: rgb(100 116 139);
    }
    #overlay {
      touch-action: none; /* crucial for iPad drawing */
    }
    canvas {
      touch-action: none; /* crucial for iPad drawing */
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-100 via-white to-slate-100 p-6 text-slate-700">
  <div class="mx-auto flex w-full max-w-[1200px] flex-col gap-6">
    <header class="rounded-[28px] border border-slate-200 bg-white/80 p-6 shadow-[0_30px_70px_rgba(30,64,175,0.18)] backdrop-blur">
      <div class="flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-3xl font-bold text-slate-900">Teacher Dashboard</h1>
          <p class="mt-2 max-w-xl text-sm text-slate-500">
            Monitor every student's canvas and annotate live with the shared toolbar.
          </p>
        </div>
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center">
          <div class="flex items-center gap-3">
            <input
              type="text"
              id="sessionInput"
              value=""
              class="w-32 rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold uppercase tracking-[0.3em] text-slate-700 shadow-inner focus:border-blue-400 focus:outline-none focus:ring-4 focus:ring-blue-100"
            />
            <button
              id="generateCodeBtn"
              type="button"
              class="rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-4 focus:ring-blue-100"
            >
              Generate code
            </button>
            <button
              id="startSessionBtn"
              type="button"
              class="rounded-2xl bg-gradient-to-r from-blue-600 to-sky-500 px-5 py-2 text-sm font-semibold text-white shadow-lg shadow-blue-900/25 transition hover:from-blue-500 hover:to-sky-400 focus:outline-none focus:ring-4 focus:ring-blue-200"
            >
              Start session
            </button>
          </div>
          <div
            id="status"
            class="inline-flex items-center justify-center rounded-full border border-blue-200 bg-blue-100 px-4 py-2 text-sm font-semibold text-blue-700"
          >
            Not connected
          </div>
        </div>
      </div>
      <div
        id="sessionInfo"
        class="mt-5 hidden items-center justify-between rounded-2xl border border-emerald-100 bg-emerald-50/70 px-4 py-3 text-sm font-semibold text-emerald-700"
      >
        <div class="flex items-center gap-4">
          <span>Session <span id="sessionCode" class="font-bold text-emerald-600"></span></span>
          <span><span id="studentCount" class="text-lg font-bold text-slate-900">0</span> students online</span>
        </div>
        <div class="flex items-center gap-4">
          <div class="flex flex-col items-center gap-2">
            <div id="qrCode" class="rounded-lg border border-emerald-200 bg-white p-2"></div>
            <p class="text-xs text-emerald-600 font-medium">Students can scan to join</p>
          </div>
          <div class="flex-1">
            <p class="text-xs text-emerald-600 mb-2">Join URL:</p>
            <div class="flex items-center gap-2">
              <input
                id="joinUrl"
                type="text"
                readonly
                class="flex-1 rounded-lg border border-emerald-200 bg-white px-3 py-2 text-xs font-mono text-slate-700 focus:outline-none"
              />
              <button
                id="copyUrlBtn"
                type="button"
                class="rounded-lg bg-emerald-500 px-3 py-2 text-xs font-semibold text-white transition hover:bg-emerald-600"
              >
                Copy
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div
      id="emptyState"
      class="flex flex-1 flex-col items-center justify-center rounded-[28px] border border-dashed border-slate-300 bg-white/70 p-12 text-center text-slate-500"
    >
      <h2 class="text-xl font-semibold text-slate-700">Waiting for students</h2>
      <p class="mt-2 max-w-sm text-sm text-slate-500">
        Share the session code so learners can join and draw in real time.
      </p>
    </div>

    <div id="students" class="grid grid-cols-1 gap-5 sm:grid-cols-2 xl:grid-cols-3"></div>
  </div>

  <div
    id="modal"
    class="invisible pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur"
  >
    <div class="pointer-events-auto flex w-full max-w-[1120px] flex-col gap-3 rounded-[24px] border border-slate-200 bg-white/85 p-3 shadow-[0_35px_80px_rgba(30,64,175,0.2)] backdrop-blur">
      <div class="flex items-center justify-between rounded-2xl border border-slate-200 bg-white/70 px-3 py-2.5">
        <div class="min-w-0">
          <h2 id="modalTitle" class="text-lg font-semibold tracking-tight text-slate-900">Annotating Student</h2>
          <p class="text-xs font-medium text-slate-500">Use the toolbar to add notes directly onto the student's canvas.</p>
        </div>
        <div class="flex items-center gap-2">
          <button
            id="teacherStylusToggle"
            class="stylus-indicator inline-flex items-center rounded-lg bg-blue-100 px-2.5 py-1 text-[11px] font-semibold text-blue-700 transition hover:bg-blue-200"
          >
            Stylus mode (pen only)
          </button>
          <button
            id="swapTeacherToolbarBtn"
            type="button"
            class="inline-flex items-center justify-center rounded-lg border border-blue-200 bg-white px-2.5 py-1 text-[11px] font-semibold text-blue-700 shadow-sm transition hover:border-blue-300 hover:text-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-200"
          >
            Move toolbar to right
          </button>
          <button
            id="closeModal"
            type="button"
            class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white px-2.5 py-1 text-[11px] font-semibold text-slate-600 shadow-sm transition hover:bg-slate-50 focus:outline-none focus:ring-4 focus:ring-slate-200"
          >
            Close
          </button>
        </div>
      </div>
      <div id="teacherWorkspace" class="flex flex-1 min-h-0 items-stretch gap-3 overflow-hidden">
        <div
          id="teacherToolbar"
          class="flex min-h-0 w-[158px] flex-col rounded-3xl border border-slate-200 bg-white/95 p-3 text-slate-700 shadow-[0_22px_55px_rgba(15,23,42,0.16)]"
        >
          <div class="flex-1 space-y-4 overflow-y-auto pr-1">
            <div class="flex flex-col items-center gap-3">
              <span class="text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-400">Colors</span>
              <div id="teacherColorPalette" class="flex flex-col items-center gap-2.5"></div>
            </div>
            <div class="space-y-3">
              <span class="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-400">Tools</span>
              <div class="flex flex-col gap-2">
                <button
                  class="tool-btn rounded-lg border border-slate-200 bg-white px-2.5 py-1 text-[11px] font-semibold text-slate-600 shadow-sm transition hover:border-slate-300 hover:bg-slate-50"
                  data-tool="pen"
                >
                  Pen
                </button>
                <button
                  class="tool-btn rounded-lg border border-slate-200 bg-white px-2.5 py-1 text-[11px] font-semibold text-slate-600 shadow-sm transition hover:border-slate-300 hover:bg-slate-50"
                  data-tool="eraser"
                >
                  Eraser
                </button>
              </div>
            </div>
            <div class="space-y-3">
              <span class="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-400">Brush Size</span>
              <div class="flex items-center justify-between gap-2 rounded-2xl bg-slate-50 px-2.5 py-2 shadow-inner">
                <input
                  type="range"
                  id="teacherBrushSize"
                  min="1"
                  max="20"
                  value="4"
                  class="h-1.5 w-full cursor-pointer appearance-none rounded-lg bg-slate-200 accent-blue-500"
                />
                <span id="teacherSizeDisplay" class="text-xs font-bold text-slate-800">4</span>
              </div>
            </div>
            <div class="space-y-3">
              <span class="block text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-400">History</span>
              <div class="flex flex-col gap-2">
                <button
                  id="teacherUndoBtn"
                  class="action-btn rounded-lg bg-slate-100 px-2.5 py-1 text-[11px] font-semibold text-slate-600 shadow-sm transition hover:bg-slate-200 disabled:cursor-not-allowed disabled:opacity-40"
                  disabled
                >
                  Undo
                </button>
                <button
                  id="teacherRedoBtn"
                  class="action-btn rounded-lg bg-slate-100 px-2.5 py-1 text-[11px] font-semibold text-slate-600 shadow-sm transition hover:bg-slate-200 disabled:cursor-not-allowed disabled:opacity-40"
                  disabled
                >
                  Redo
                </button>
                <button
                  id="teacherClearBtn"
                  class="action-btn rounded-lg bg-rose-100 px-2.5 py-1 text-[11px] font-semibold text-rose-600 shadow-sm transition hover:bg-rose-200 disabled:cursor-not-allowed disabled:opacity-40"
                  disabled
                >
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="flex min-h-0 flex-1 items-center justify-center rounded-[24px] border border-slate-200 bg-white/65 p-3 shadow-inner">
          <div
            id="teacherStage"
            class="flex h-full max-h-[640px] w-full max-w-[840px] flex-1 items-center justify-center overflow-hidden rounded-[20px] border border-slate-200 bg-white p-3 shadow-[0_20px_55px_rgba(15,23,42,0.12)]"
          >
            <div class="relative">
              <canvas
                id="bigCanvas"
                width="800"
                height="600"
                class="block max-h-full max-w-full rounded-2xl bg-white shadow-inner shadow-slate-900/5"
              ></canvas>
              <canvas
                id="overlay"
                width="800"
                height="600"
                class="pointer-events-auto absolute left-0 top-0 max-h-full max-w-full rounded-2xl"
              ></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.SUPABASE_URL = "https://eytswszeopdxmtxxbkrb.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5dHN3c3plb3BkeG10eHhia3JiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NTI5ODQsImV4cCI6MjA3NDEyODk4NH0.7skddGtrUoXluvK9JDS54bpmKCxVYeofzWATmJIgABE";
  </script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/+esm';

    const COLOR_PRESETS = [
      { label: 'Red', value: '#ef4444' },
      { label: 'Purple', value: '#8b5cf6' },
      { label: 'Teal', value: '#0d9488' }
    ];

    const MIN_SAMPLE_DISTANCE = 0.45;
    const INTERPOLATION_STEP = 3.2;

    const studentsGrid = document.getElementById('students');
    const emptyState = document.getElementById('emptyState');
    const statusBadge = document.getElementById('status');
    const sessionInput = document.getElementById('sessionInput');
    const generateCodeBtn = document.getElementById('generateCodeBtn');
    const startSessionBtn = document.getElementById('startSessionBtn');
    const sessionInfo = document.getElementById('sessionInfo');
    const sessionCodeEl = document.getElementById('sessionCode');
    const studentCountEl = document.getElementById('studentCount');
    const qrCodeCanvas = document.getElementById('qrCode');
    const joinUrlInput = document.getElementById('joinUrl');
    const copyUrlBtn = document.getElementById('copyUrlBtn');

    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const closeModal = document.getElementById('closeModal');
    const bigCanvas = document.getElementById('bigCanvas');
    const bigCtx = bigCanvas.getContext('2d', { alpha: false, desynchronized: true });
    const overlay = document.getElementById('overlay');
    const overlayCtx = overlay.getContext('2d', { alpha: true, desynchronized: true });

    const teacherToolbar = document.getElementById('teacherToolbar');
    const teacherColorPalette = document.getElementById('teacherColorPalette');
    const teacherToolButtons = Array.from(teacherToolbar.querySelectorAll('.tool-btn'));
    const teacherBrushSize = document.getElementById('teacherBrushSize');
    const teacherSizeDisplay = document.getElementById('teacherSizeDisplay');
    const teacherUndoBtn = document.getElementById('teacherUndoBtn');
    const teacherRedoBtn = document.getElementById('teacherRedoBtn');
    const teacherClearBtn = document.getElementById('teacherClearBtn');
    const teacherStylusToggle = document.getElementById('teacherStylusToggle');
    const swapTeacherToolbarBtn = document.getElementById('swapTeacherToolbarBtn');
    const teacherWorkspace = document.getElementById('teacherWorkspace');
    const teacherStage = document.getElementById('teacherStage');

    overlay.style.touchAction = 'none';
    const usePointerRawUpdate = 'onpointerrawupdate' in window;

    /* ----------------- Pointer filtering for stylus mode ----------------- */
    function supportedPointer(e) {
      const t = (e.pointerType || '').toLowerCase();
      if (teacherStylusOnly) return t === '' || t === 'pen';
      return t === '' || t === 'pen' || t === 'mouse' || t === 'touch';
    }

    let supabaseClient = null;
    let channel = null;
    let sessionCode = '';
    // 6-character alphanumeric (A-Z, 0-9)
    function generateAlphanumericCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ0123456789'; // exclude ambiguous I/O
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    function setSessionCode(code) {
      sessionCode = (code || '').toUpperCase();
      sessionInput.value = sessionCode;
      // Build join URL for students
      try {
        const base = new URL(window.location.href);
        base.search = '';
        base.hash = '';
        base.pathname = base.pathname.replace('teacher.html', 'student.html');
        const join = new URL(base);
        join.searchParams.set('session', sessionCode);
        if (joinUrlInput) joinUrlInput.value = join.toString();
        if (qrCodeCanvas && typeof QRCode !== 'undefined') {
          qrCodeCanvas.innerHTML = '';
          new QRCode(qrCodeCanvas, { text: join.toString(), width: 120, height: 120 });
        }
      } catch {}
    }

    // Wire generator button
    generateCodeBtn.addEventListener('click', () => {
      if (channel) return; // do not change during an active session
      setSessionCode(generateAlphanumericCode());
    });

    // Auto-generate if empty on load
    if (!sessionInput.value.trim()) {
      setSessionCode(generateAlphanumericCode());
    } else {
      setSessionCode(sessionInput.value.trim());
    }

    const students = new Map();
    const activeRemoteStrokes = new Map();

    let currentStudent = null;

    let teacherCurrentColor = COLOR_PRESETS[0].value;
    let teacherCurrentTool = 'pen';
    let teacherBrush = 4;
    let teacherStylusOnly = true;

    let annotationPointerId = null;
    let activeAnnotationStroke = null;
    let teacherErasing = false;
    let teacherLastErasePoint = null;
    let erasedAnnotationIds = new Set();

    function setStatus(state, text) {
      statusBadge.textContent = text;
      statusBadge.className = 'inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-semibold transition-colors';
      if (state === 'connected') {
        statusBadge.classList.add('border', 'border-emerald-200', 'bg-emerald-100', 'text-emerald-700');
      } else if (state === 'error') {
        statusBadge.classList.add('border', 'border-rose-200', 'bg-rose-100', 'text-rose-600');
      } else {
        statusBadge.classList.add('border', 'border-blue-200', 'bg-blue-100', 'text-blue-700');
      }
    }

    function appendPointWithInterpolation(array, point) {
      if (!point) return;
      const last = array[array.length - 1];
      if (last) {
        const dx = point.x - last.x;
        const dy = point.y - last.y;
        const dist = Math.hypot(dx, dy);
        if (dist < MIN_SAMPLE_DISTANCE) {
          last.x += dx * 0.5;
          last.y += dy * 0.5;
          return;
        }
        const steps = Math.min(6, Math.floor(dist / INTERPOLATION_STEP));
        for (let i = 1; i < steps; i++) {
          const t = i / steps;
          array.push({ x: last.x + dx * t, y: last.y + dy * t });
        }
      }
      array.push(point);
    }

    function appendSamples(array, samples) {
      samples.forEach(sample => appendPointWithInterpolation(array, { x: sample.x, y: sample.y }));
    }

    function drawSmoothStrokePath(targetCtx, points, color, size) {
      if (!points?.length) return;
      const strokeColor = color || '#111827';
      const strokeSize = Math.max(0.5, Number.isFinite(size) ? size : 3);

      targetCtx.save();
      targetCtx.lineCap = 'round';
      targetCtx.lineJoin = 'round';
      targetCtx.strokeStyle = strokeColor;
      targetCtx.lineWidth = strokeSize;
      targetCtx.fillStyle = strokeColor;

      if (points.length === 1) {
        targetCtx.beginPath();
        targetCtx.arc(points[0].x, points[0].y, strokeSize / 2, 0, Math.PI * 2);
        targetCtx.fill();
        targetCtx.restore();
        return;
      }

      targetCtx.beginPath();
      targetCtx.moveTo(points[0].x, points[0].y);
      for (let i = 0; i < points.length - 1; i++) {
        const p0 = i === 0 ? points[0] : points[i - 1];
        const p1 = points[i];
        const p2 = points[i + 1];
        const p3 = i + 2 < points.length ? points[i + 2] : points[i + 1];

        const cp1x = p1.x + (p2.x - p0.x) / 6;
        const cp1y = p1.y + (p2.y - p0.y) / 6;
        const cp2x = p2.x - (p3.x - p1.x) / 6;
        const cp2y = p2.y - (p3.y - p1.y) / 6;

        targetCtx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
      }

      targetCtx.stroke();
      targetCtx.restore();
    }

    function distToSegmentSquared(px, py, x1, y1, x2, y2) {
      const dx = x2 - x1;
      const dy = y2 - y1;
      const len2 = dx * dx + dy * dy;
      if (len2 === 0) return (px - x1) ** 2 + (py - y1) ** 2;
      let t = ((px - x1) * dx + (py - y1) * dy) / len2;
      t = Math.max(0, Math.min(1, t));
      const qx = x1 + t * dx;
      const qy = y1 + t * dy;
      return (px - qx) ** 2 + (py - qy) ** 2;
    }

    function renderColorPalette(container, onSelect, currentValue) {
      container.innerHTML = '';
      COLOR_PRESETS.forEach(preset => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'color-btn flex h-9 w-9 items-center justify-center rounded-full border-2 border-transparent shadow-sm';
        btn.dataset.color = preset.value;
        btn.title = preset.label;
        btn.setAttribute('aria-label', preset.label);
        btn.style.background = preset.value;
        btn.addEventListener('click', () => onSelect(preset.value));
        container.appendChild(btn);
      });
      Array.from(container.querySelectorAll('.color-btn')).forEach(btn => {
        btn.classList.toggle('active', btn.dataset.color === currentValue);
      });
    }

    function updateTeacherColorSelection() {
      Array.from(teacherColorPalette.querySelectorAll('.color-btn')).forEach(btn => {
        btn.classList.toggle('active', btn.dataset.color === teacherCurrentColor);
      });
    }

    function updateTeacherToolButtons() {
      teacherToolButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tool === teacherCurrentTool));
    }

    function updateAnnotationButtons() {
      const student = currentStudent;
      const hasUndo = Boolean(student) && student.annotationUndoStack.length > 0;
      const hasRedo = Boolean(student) && student.annotationRedoStack.length > 0;
      const hasContent = Boolean(student) && student.annotations.length > 0;
      teacherUndoBtn.disabled = !hasUndo;
      teacherRedoBtn.disabled = !hasRedo;
      teacherClearBtn.disabled = !hasContent;
    }

    function ensureStudent(username) {
      if (students.has(username)) return students.get(username);

      emptyState.classList.add('hidden');

      const baseCanvas = document.createElement('canvas');
      baseCanvas.width = 800;
      baseCanvas.height = 600;
      const baseCtx = baseCanvas.getContext('2d', { alpha: false });
      baseCtx.fillStyle = '#ffffff';
      baseCtx.fillRect(0, 0, 800, 600);

      const previewCanvas = document.createElement('canvas');
      previewCanvas.width = 400;
      previewCanvas.height = 300;
      const previewCtx = previewCanvas.getContext('2d');
      previewCtx.fillStyle = '#ffffff';
      previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);

      const card = document.createElement('article');
      card.className = 'flex flex-col gap-4 rounded-[24px] border border-slate-200 bg-white/85 p-5 shadow-[0_20px_55px_rgba(30,41,59,0.12)] backdrop-blur';
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-slate-900">${username}</h3>
          <span class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-500">Live</span>
        </div>
        <div class="relative aspect-[4/3] w-full overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-inner">
          <canvas class="absolute inset-0 h-full w-full" width="400" height="300"></canvas>
        </div>
        <button type="button" class="inline-flex items-center justify-center rounded-2xl bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-md transition hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-200">Open canvas</button>
      `;
      const previewElement = card.querySelector('canvas');
      previewElement.replaceWith(previewCanvas);
      studentsGrid.appendChild(card);

      const student = {
        username,
        strokes: [],
        canvas: baseCanvas,
        ctx: baseCtx,
        previewCanvas,
        previewCtx,
        card,
        annotations: [],
        annotationUndoStack: [],
        annotationRedoStack: [],
        eraseBatch: null
      };
      students.set(username, student);
      studentCountEl.textContent = students.size;

      card.querySelector('button').addEventListener('click', () => openModalForStudent(student));

      renderStudent(student);
      return student;
    }

    function getActiveStrokeMap(username) {
      if (!activeRemoteStrokes.has(username)) {
        activeRemoteStrokes.set(username, new Map());
      }
      return activeRemoteStrokes.get(username);
    }

    function renderStudent(student) {
      const ctx = student.ctx;
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, 800, 600);
      student.strokes.forEach(stroke => drawSmoothStrokePath(ctx, stroke.points, stroke.color, stroke.size));
      const active = activeRemoteStrokes.get(student.username);
      if (active) {
        active.forEach(stroke => drawSmoothStrokePath(ctx, stroke.points, stroke.color, stroke.size));
      }

      student.previewCtx.clearRect(0, 0, student.previewCanvas.width, student.previewCanvas.height);
      student.previewCtx.drawImage(student.canvas, 0, 0, student.previewCanvas.width, student.previewCanvas.height);
      student.previewCtx.save();
      student.previewCtx.scale(student.previewCanvas.width / 800, student.previewCanvas.height / 600);
      student.annotations.forEach(stroke => {
        if (stroke) drawSmoothStrokePath(student.previewCtx, stroke.points, stroke.color, stroke.size);
      });
      student.previewCtx.restore();

      if (currentStudent && currentStudent.username === student.username) {
        bigCtx.fillStyle = '#ffffff';
        bigCtx.fillRect(0, 0, bigCanvas.width, bigCanvas.height);
        bigCtx.drawImage(student.canvas, 0, 0);
        redrawAnnotationOverlay(activeAnnotationStroke?.points || null);
      }
    }

    function openModalForStudent(student) {
      currentStudent = student;
      modalTitle.textContent = `Annotating ${student.username}`;
      bigCtx.fillStyle = '#ffffff';
      bigCtx.fillRect(0, 0, bigCanvas.width, bigCanvas.height);
      bigCtx.drawImage(student.canvas, 0, 0);
      redrawAnnotationOverlay();
      updateAnnotationButtons();
      modal.classList.remove('invisible', 'pointer-events-none');
      modal.classList.add('pointer-events-auto');
      updateTeacherColorSelection();
      updateTeacherToolButtons();
    }

    function closeModalView() {
      modal.classList.add('invisible', 'pointer-events-none');
      modal.classList.remove('pointer-events-auto');
      currentStudent = null;
      annotationPointerId = null;
      activeAnnotationStroke = null;
      teacherErasing = false;
      teacherLastErasePoint = null;
      erasedAnnotationIds.clear();
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
      updateAnnotationButtons();
    }

    closeModal.addEventListener('click', closeModalView);
    modal.addEventListener('click', (event) => {
      if (event.target === modal) closeModalView();
    });

    renderColorPalette(teacherColorPalette, (color) => {
      teacherCurrentColor = color;
      updateTeacherColorSelection();
      if (teacherCurrentTool === 'eraser') {
        teacherCurrentTool = 'pen';
        updateTeacherToolButtons();
      }
    }, teacherCurrentColor);

    teacherToolButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        teacherCurrentTool = btn.dataset.tool;
        updateTeacherToolButtons();
      });
    });
    updateTeacherToolButtons();
    updateTeacherColorSelection();

    teacherBrushSize.addEventListener('input', (e) => {
      teacherBrush = parseInt(e.target.value, 10);
      teacherSizeDisplay.textContent = teacherBrush;
    });

    teacherStylusToggle.addEventListener('click', () => {
      teacherStylusOnly = !teacherStylusOnly;
      teacherStylusToggle.classList.toggle('off', !teacherStylusOnly);
      teacherStylusToggle.textContent = teacherStylusOnly ? 'Stylus mode (pen only)' : 'All inputs';
    });

    let teacherToolbarOnLeft = true;
    function updateTeacherToolbarPosition() {
      if (teacherToolbarOnLeft) {
        teacherWorkspace.classList.remove('flex-row-reverse');
        swapTeacherToolbarBtn.textContent = 'Move toolbar to right';
        swapTeacherToolbarBtn.setAttribute('aria-pressed', 'false');
      } else {
        teacherWorkspace.classList.add('flex-row-reverse');
        swapTeacherToolbarBtn.textContent = 'Move toolbar to left';
        swapTeacherToolbarBtn.setAttribute('aria-pressed', 'true');
      }
    }
    swapTeacherToolbarBtn.addEventListener('click', () => {
      teacherToolbarOnLeft = !teacherToolbarOnLeft;
      updateTeacherToolbarPosition();
    });
    updateTeacherToolbarPosition();

    function redrawAnnotationOverlay(activePoints = null) {
      overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
      if (!currentStudent) return;
      currentStudent.annotations.forEach(stroke => {
        if (stroke) drawSmoothStrokePath(overlayCtx, stroke.points, stroke.color, stroke.size);
      });
      if (activePoints?.length && activeAnnotationStroke) {
        drawSmoothStrokePath(overlayCtx, activePoints, activeAnnotationStroke.color, activeAnnotationStroke.size);
      }
    }

    function getOverlayPoint(ev) {
      const rect = overlay.getBoundingClientRect();
      return { x: ((ev.clientX - rect.left) * overlay.width) / rect.width, y: ((ev.clientY - rect.top) * overlay.height) / rect.height };
    }

    function getOverlaySamples(ev) {
      const list = ev.getCoalescedEvents ? ev.getCoalescedEvents() : [ev];
      return list.map(item => getOverlayPoint(item));
    }

    function beginAnnotationStroke(point) {
      activeAnnotationStroke = {
        id: `${Date.now()}-teacher-${Math.random().toString(16).slice(2)}`,
        color: teacherCurrentColor,
        size: teacherBrush,
        points: []
      };
      appendSamples(activeAnnotationStroke.points, [point]);
      redrawAnnotationOverlay(activeAnnotationStroke.points);
    }

    function commitAnnotationStroke(stroke) {
      if (!currentStudent || !stroke.points?.length) return;
      const student = currentStudent;
      const committed = {
        id: stroke.id,
        color: stroke.color,
        size: stroke.size,
        points: stroke.points.map(p => ({ x: p.x, y: p.y })),
        isTeacher: true
      };
      student.annotations.push(committed);
      student.annotationUndoStack.push({ type: 'draw', path: committed });
      student.annotationRedoStack.length = 0;
      redrawAnnotationOverlay();
      updateAnnotationButtons();
      renderStudent(student);
      channel?.send({ type: 'broadcast', event: 'teacher_stroke_end', payload: { target: student.username, stroke: committed } });
    }

    function beginTeacherErase(point) {
      if (!currentStudent) return;
      teacherErasing = true;
      erasedAnnotationIds.clear();
      currentStudent.eraseBatch = [];
      teacherLastErasePoint = point;
      deleteAnnotationsAt(point.x, point.y);
    }

    function continueTeacherErase(ev) {
      if (!teacherErasing || !currentStudent) return;
      const list = ev.getCoalescedEvents ? ev.getCoalescedEvents() : [ev];
      for (const ce of list) {
        const point = getOverlayPoint(ce);
        if (teacherLastErasePoint) {
          const dx = point.x - teacherLastErasePoint.x;
          const dy = point.y - teacherLastErasePoint.y;
          const dist = Math.hypot(dx, dy);
          const steps = Math.max(1, Math.floor(dist / 8));
          for (let i = 1; i <= steps; i++) {
            const t = i / steps;
            deleteAnnotationsAt(
              teacherLastErasePoint.x + dx * t,
              teacherLastErasePoint.y + dy * t
            );
          }
        } else {
          deleteAnnotationsAt(point.x, point.y);
        }
        teacherLastErasePoint = point;
      }
    }

    function endTeacherErase() {
      if (!currentStudent) return;
      const batch = currentStudent.eraseBatch || [];
      if (batch.length) {
        currentStudent.annotationUndoStack.push({ type: 'erase', entries: batch });
        currentStudent.annotationRedoStack.length = 0;
        updateAnnotationButtons();
      }
      currentStudent.eraseBatch = null;
      teacherErasing = false;
      teacherLastErasePoint = null;
      erasedAnnotationIds.clear();
    }

    function deleteAnnotationsAt(x, y) {
      if (!currentStudent) return;
      const student = currentStudent;
      const radius = Math.max(28, teacherBrush * 3);
      let removed = false;
      for (let i = student.annotations.length - 1; i >= 0; i--) {
        const stroke = student.annotations[i];
        if (!stroke || erasedAnnotationIds.has(stroke.id)) continue;
        const hit = stroke.points.some((p, idx) => {
          const dist = Math.hypot(p.x - x, p.y - y);
          if (dist <= radius + (stroke.size || 3) / 2) return true;
          if (idx > 0) {
            const prev = stroke.points[idx - 1];
            const d2 = distToSegmentSquared(x, y, prev.x, prev.y, p.x, p.y);
            return d2 <= (radius + (stroke.size || 3) / 2) ** 2;
          }
          return false;
        });
        if (hit) {
          const [removedStroke] = student.annotations.splice(i, 1);
          if (!student.eraseBatch) student.eraseBatch = [];
          student.eraseBatch.push({ path: removedStroke, index: i });
          erasedAnnotationIds.add(removedStroke.id);
          removed = true;
          channel?.send({ type: 'broadcast', event: 'teacher_stroke_delete', payload: { target: student.username, strokeId: removedStroke.id } });
        }
      }
      if (removed) {
        redrawAnnotationOverlay(activeAnnotationStroke?.points || null);
        renderStudent(student);
      }
    }

    overlay.addEventListener('pointerdown', (ev) => {
      if (!currentStudent) return;
      if (!supportedPointer(ev)) return;
      ev.preventDefault();
      annotationPointerId = ev.pointerId;
      overlay.setPointerCapture(annotationPointerId);
      const point = getOverlayPoint(ev);
      if (teacherCurrentTool === 'eraser') {
        beginTeacherErase(point);
        return;
      }
      beginAnnotationStroke(point);
    });

    function handleOverlayPointerMove(ev) {
      if (ev.pointerId !== annotationPointerId) return;
      if (!supportedPointer(ev)) return;
      if (teacherCurrentTool === 'eraser') {
        ev.preventDefault();
        continueTeacherErase(ev);
        return;
      }
      if (!activeAnnotationStroke) return;
      ev.preventDefault();
      const samples = getOverlaySamples(ev);
      if (!samples.length) return;
      appendSamples(activeAnnotationStroke.points, samples);
      redrawAnnotationOverlay(activeAnnotationStroke.points);
    }

    if (usePointerRawUpdate) {
      overlay.addEventListener('pointerrawupdate', handleOverlayPointerMove);
    } else {
      overlay.addEventListener('pointermove', handleOverlayPointerMove);
    }

    function finalizeOverlayPointer(ev) {
      if (ev.pointerId !== annotationPointerId) return;
      if (teacherCurrentTool === 'eraser') {
        endTeacherErase();
        try { overlay.releasePointerCapture(ev.pointerId); } catch {}
        annotationPointerId = null;
        return;
      }
      if (activeAnnotationStroke) {
        commitAnnotationStroke(activeAnnotationStroke);
      }
      activeAnnotationStroke = null;
      annotationPointerId = null;
      try { overlay.releasePointerCapture(ev.pointerId); } catch {}
    }

    overlay.addEventListener('pointerup', finalizeOverlayPointer);
    overlay.addEventListener('pointerleave', finalizeOverlayPointer);
    overlay.addEventListener('pointercancel', finalizeOverlayPointer);

    // Prevent iPad gestures interfering with drawing
    ['touchstart', 'touchmove', 'gesturestart'].forEach(ev => {
      overlay.addEventListener(ev, e => { e.preventDefault(); }, { passive: false });
    });

    function cloneAnnotationPaths(arr) {
      return arr.map(p => ({
        id: p.id,
        color: p.color,
        size: p.size,
        isTeacher: p.isTeacher,
        points: p.points.map(q => ({ x: q.x, y: q.y }))
      }));
    }

    teacherUndoBtn.addEventListener('click', () => {
      if (!currentStudent || !currentStudent.annotationUndoStack.length) return;
      const action = currentStudent.annotationUndoStack.pop();

      if (action.type === 'draw') {
        const path = action.path;
        let idx = currentStudent.annotations.lastIndexOf(path);
        if (idx === -1 && path?.id) {
          idx = currentStudent.annotations.findIndex(s => s.id === path.id);
        }
        if (idx !== -1) {
          currentStudent.annotations.splice(idx, 1);
          currentStudent.annotationRedoStack.push({ type: 'draw', path });
        }
        channel?.send({ type: 'broadcast', event: 'teacher_state_change', payload: { target: currentStudent.username, removed: [path.id] } });
      }

      else if (action.type === 'erase') {
        const entries = action.entries || [];
        for (let i = entries.length - 1; i >= 0; i--) {
          const { path, index } = entries[i];
          const insertAt = Number.isFinite(index) ? Math.min(index, currentStudent.annotations.length) : currentStudent.annotations.length;
          currentStudent.annotations.splice(insertAt, 0, path);
        }
        currentStudent.annotationRedoStack.push({ type: 'erase', entries });
        const added = entries.map(e => ({ ...e.path, points: e.path.points.map(p => ({ x: p.x, y: p.y })) }));
        channel?.send({ type: 'broadcast', event: 'teacher_state_change', payload: { target: currentStudent.username, added } });
      }

      else if (action.type === 'clear') {
        const prev = action.prev || [];
        currentStudent.annotationRedoStack.push({ type: 'clear', prev: cloneAnnotationPaths(currentStudent.annotations) });
        currentStudent.annotations = cloneAnnotationPaths(prev);
        const added = prev.map(p => ({ ...p, points: p.points.map(pt => ({ x: pt.x, y: pt.y })) }));
        channel?.send({ type: 'broadcast', event: 'teacher_state_change', payload: { target: currentStudent.username, added } });
      }

      redrawAnnotationOverlay();
      updateAnnotationButtons();
      renderStudent(currentStudent);
    });

    teacherRedoBtn.addEventListener('click', () => {
      if (!currentStudent || !currentStudent.annotationRedoStack.length) return;
      const action = currentStudent.annotationRedoStack.pop();

      if (action.type === 'draw') {
        const path = action.path;
        currentStudent.annotations.push(path);
        currentStudent.annotationUndoStack.push({ type: 'draw', path });
        channel?.send({ type: 'broadcast', event: 'teacher_stroke_end', payload: { target: currentStudent.username, stroke: { ...path, points: path.points.map(p => ({ x: p.x, y: p.y })) } } });
      }

      else if (action.type === 'erase') {
        const performed = [];
        (action.entries || []).forEach(({ path, index }) => {
          let idx = currentStudent.annotations.indexOf(path);
          if (idx === -1 && path?.id) {
            idx = currentStudent.annotations.findIndex(s => s.id === path.id);
          }
          if (idx !== -1) {
            currentStudent.annotations.splice(idx, 1);
            performed.push({ path, index: idx });
          } else if (Number.isFinite(index) && index >= 0 && index < currentStudent.annotations.length) {
            const [removed] = currentStudent.annotations.splice(index, 1);
            if (removed) performed.push({ path: removed, index });
          }
        });
        currentStudent.annotationUndoStack.push({ type: 'erase', entries: performed });
        const removed = performed.map(e => e.path.id);
        channel?.send({ type: 'broadcast', event: 'teacher_state_change', payload: { target: currentStudent.username, removed } });
      }

      else if (action.type === 'clear') {
        const snapshot = cloneAnnotationPaths(currentStudent.annotations);
        currentStudent.annotations = [];
        currentStudent.annotationUndoStack.push({ type: 'clear', prev: snapshot });
        channel?.send({ type: 'broadcast', event: 'teacher_clear', payload: { target: currentStudent.username } });
      }

      redrawAnnotationOverlay();
      updateAnnotationButtons();
      renderStudent(currentStudent);
    });

    teacherClearBtn.addEventListener('click', () => {
      if (!currentStudent || !currentStudent.annotations.length) return;
      const snapshot = cloneAnnotationPaths(currentStudent.annotations);
      currentStudent.annotations = [];
      currentStudent.annotationUndoStack.push({ type: 'clear', prev: snapshot });
      currentStudent.annotationRedoStack.length = 0;
      redrawAnnotationOverlay();
      updateAnnotationButtons();
      renderStudent(currentStudent);
      channel?.send({ type: 'broadcast', event: 'teacher_clear', payload: { target: currentStudent.username } });
    });

    function addStudentStroke(username, stroke) {
      const student = ensureStudent(username);
      if (!stroke?.id || !stroke.points?.length) return;
      if (student.strokes.some(s => s.id === stroke.id)) return;
      student.strokes.push({ id: stroke.id, color: stroke.color || '#111827', size: stroke.size || 3, points: stroke.points.map(p => ({ x: p.x, y: p.y })) });
      renderStudent(student);
    }

    function removeStudentStroke(username, strokeId) {
      const student = students.get(username);
      if (!student) return;
      const idx = student.strokes.findIndex(s => s.id === strokeId);
      if (idx >= 0) {
        student.strokes.splice(idx, 1);
        renderStudent(student);
      }
      const activeMap = activeRemoteStrokes.get(username);
      activeMap?.delete(strokeId);
    }

    function applyStudentStateChange(username, payload) {
      const student = ensureStudent(username);
      (payload.added || []).forEach(stroke => {
        if (!student.strokes.some(s => s.id === stroke.id)) {
          student.strokes.push({ id: stroke.id, color: stroke.color || '#111827', size: stroke.size || 3, points: (stroke.points || []).map(p => ({ x: p.x, y: p.y })) });
        }
      });
      (payload.removed || []).forEach(id => {
        const idx = student.strokes.findIndex(s => s.id === id);
        if (idx >= 0) student.strokes.splice(idx, 1);
        const activeMap = activeRemoteStrokes.get(username);
        activeMap?.delete(id);
      });
      renderStudent(student);
    }

    function handleStudentClear(username) {
      const student = students.get(username);
      if (!student) return;
      student.strokes = [];
      renderStudent(student);
      activeRemoteStrokes.delete(username);
    }

    startSessionBtn.addEventListener('click', startSession);

    // Copy URL button
    copyUrlBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(joinUrlInput.value);
        copyUrlBtn.textContent = 'Copied!';
        setTimeout(() => { copyUrlBtn.textContent = 'Copy'; }, 1500);
      } catch {}
    });

    function startSession() {
      if (channel) return;
      sessionCode = sessionInput.value.trim().toUpperCase();
      if (!sessionCode) {
        alert('Enter a session code to start.');
        return;
      }
      supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      channel = supabaseClient.channel(`minimal-${sessionCode}`, { config: { broadcast: { ack: false } } });

      channel.on('broadcast', { event: 'student_ready' }, ({ payload }) => {
        if (!payload?.username) return;
        ensureStudent(payload.username);
      });

      channel.on('broadcast', { event: 'student_stroke_start' }, ({ payload }) => {
        if (!payload?.username || !payload.stroke?.id) return;
        const student = ensureStudent(payload.username);
        const activeMap = getActiveStrokeMap(payload.username);
        activeMap.set(payload.stroke.id, { id: payload.stroke.id, color: payload.stroke.color || '#111827', size: payload.stroke.size || 3, points: [] });
        renderStudent(student);
      });

      channel.on('broadcast', { event: 'student_stroke_point' }, ({ payload }) => {
        if (!payload?.username || !payload.strokeId) return;
        const activeMap = getActiveStrokeMap(payload.username);
        const stroke = activeMap.get(payload.strokeId);
        if (!stroke) return;
        appendPointWithInterpolation(stroke.points, { x: payload.x, y: payload.y });
        const student = ensureStudent(payload.username);
        renderStudent(student);
      });

      channel.on('broadcast', { event: 'student_stroke_end' }, ({ payload }) => {
        if (!payload?.username || !payload.stroke) return;
        const activeMap = getActiveStrokeMap(payload.username);
        activeMap.delete(payload.stroke.id);
        addStudentStroke(payload.username, payload.stroke);
      });

      channel.on('broadcast', { event: 'student_state_change' }, ({ payload }) => {
        if (!payload?.username) return;
        applyStudentStateChange(payload.username, payload);
      });

      channel.on('broadcast', { event: 'student_stroke_delete' }, ({ payload }) => {
        if (!payload?.username || !payload.strokeId) return;
        removeStudentStroke(payload.username, payload.strokeId);
      });

      channel.on('broadcast', { event: 'student_clear' }, ({ payload }) => {
        if (!payload?.username) return;
        handleStudentClear(payload.username);
      });

      channel.subscribe((status) => {
        if (status === 'SUBSCRIBED') {
          setStatus('connected', 'Connected');
          sessionInfo.classList.remove('hidden');
          sessionCodeEl.textContent = sessionCode;
          channel.send({ type: 'broadcast', event: 'teacher_ready', payload: { sessionCode } });
        } else if (status === 'CHANNEL_ERROR') {
          setStatus('error', 'Connection error');
        }
      });

      startSessionBtn.disabled = true;
      startSessionBtn.textContent = 'Session live';
      setStatus('connecting', 'Connectingâ€¦');
    }

    startSession();
  </script>
</body>
</html>